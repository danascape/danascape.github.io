<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using AOSP Kernel Build | Saalim Quadri</title><meta name=keywords content><meta name=description content="In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.

This blog covers 2 aspects:

Compile using Legacy AOSP Kernel Build
Add support for bazel Kernel Build

Bazel is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it&rsquo;s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP."><meta name=author content="squadri"><link rel=canonical href=https://danascape.github.io/posts/6/><link crossorigin=anonymous href=/assets/css/stylesheet.ecb14332dfba04052a266caa0f33168daa8dd2df45fe49adcb98d99df3cb40f6.css integrity="sha256-7LFDMt+6BAUqJmyqDzMWjaqN0t9F/kmty5jZnfPLQPY=" rel="preload stylesheet" as=style><link rel=icon href=https://danascape.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://danascape.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://danascape.github.io/favicon.ico><link rel=apple-touch-icon href=https://danascape.github.io/favicon.ico><link rel=mask-icon href=https://danascape.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://danascape.github.io/posts/6/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://danascape.github.io/posts/6/"><meta property="og:site_name" content="Saalim Quadri"><meta property="og:title" content="Using AOSP Kernel Build"><meta property="og:description" content="In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.
This blog covers 2 aspects:
Compile using Legacy AOSP Kernel Build Add support for bazel Kernel Build Bazel is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it’s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-14T00:00:00+05:30"><meta property="article:modified_time" content="2024-08-14T00:00:00+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using AOSP Kernel Build"><meta name=twitter:description content="In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.

This blog covers 2 aspects:

Compile using Legacy AOSP Kernel Build
Add support for bazel Kernel Build

Bazel is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it&rsquo;s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://danascape.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Using AOSP Kernel Build","item":"https://danascape.github.io/posts/6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using AOSP Kernel Build","name":"Using AOSP Kernel Build","description":"In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.\nThis blog covers 2 aspects:\nCompile using Legacy AOSP Kernel Build Add support for bazel Kernel Build Bazel is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it\u0026rsquo;s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP.\n","keywords":[],"articleBody":"In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.\nThis blog covers 2 aspects:\nCompile using Legacy AOSP Kernel Build Add support for bazel Kernel Build Bazel is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it’s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP.\nAOSP Kernel Build System is the system used to compile the Linux kernel for Android devices. It includes the necessary build scripts, configurations, and toolchains needed to build the kernel from source. The build system is designed to work with AOSP’s infrastructure and often uses tools like make and ninja for the actual compilation process.\nIn recent years, Bazel has been adopted by some parts of the AOSP for building specific components, but the traditional kernel build process has largely remained based on make. However, there’s ongoing work to integrate Bazel more deeply into AOSP’s build system to leverage its advantages, like better dependency tracking and faster builds.\nPrerequisites Before diving into the AOSP Kernel Build process, certain requirements need to be met:\nBasic File and Text Editing: Familiarity with editing and writing files and text in a Linux environment. Linux Command Line: Comfort with using the Linux command line interface. Basic Git Knowledge: Understanding basic Git commands and workflows. Repo Sync and Manifests: Familiarity with syncing repositories using repo sync and working with manifest files. Establishing a Build Environment If you’ve already set up a Linux build environment, you can skip this step. Otherwise, follow these instructions to get started:\nSetup Script: Run the following command on your Linux machine with elevated permissions to set up the necessary environment: curl https://raw.githubusercontent.com/akhilnarang/scripts/master/setup/android_build_env.sh | sudo sh This script will install all the required dependencies for building the AOSP Kernel.\nSetup Kernel Manifest To build the AOSP kernel, you need to set up a kernel manifest, which will allow you to sync the required scripts and compiler.\nTo do that, head to here and sync the required manifest. I would recommend using common- and your kernel version branch.\nrepo init -u https://android.googlesource.com/kernel/manifest/ -b common-android-4.19-stable --depth 1 Depth Sync: The --depth 1 option is used to perform a shallow sync, which is faster because it doesn’t download the entire history. This is ideal if you don’t need to develop on the build system itself. If you do plan to develop further, you can perform a full sync by omitting the --depth 1 option. After a sync, you can view the structure of the source tree:\n~/kernel/sp# tree -L 1 . ├── build ├── common ├── common-modules ├── hikey-modules ├── kernel ├── prebuilts ├── prebuilts-master └── tools 8 directories, 0 files Inside the common/ directory, you’ll find the Android Common Kernel source, which we won’t need for our purposes. You can replace this with your own kernel source.\nReplace common kernel directory with your kernel source with version V4.19.\nSetup Build Config The AOSP Kernel Build system relies on a BUILD_CONFIG variable, which configures the build environment, including kernel configuration and compiler flags.\nCreate a file named build.config. Write basic configuration, like your kernel build directory, which is set to common by default, then required defconfig KERNEL_DIR=common . ${ROOT_DIR}/${KERNEL_DIR}/build.config.billie.common.clang Create a file named build.config..common.clang Specify compiler settings, I am differing the names with my perspective, these can be anything. . ${ROOT_DIR}/${KERNEL_DIR}/build.config.billie.common CC=clang LD=ld.lld CLANG_TRIPLE=aarch64-linux-gnu- Create a file named build.config.billie.common To call the common configuration and define additional settings. . ${ROOT_DIR}/${KERNEL_DIR}/build.config.common BUILD_INITRAMFS=1 DEFCONFIG=vendor/billie-perf_defconfig Here, the build.config.common file, which is already present in the kernel directory, contains the remaining configuration.\nYou can find the full reference commit here. Fill in the remaining configuration details as per your needs. Depending on your kernel version, you can fully utilize the Build System to start the kernel build process and package the distribution into a boot image.\nStarting the build Once you have set up your build environment and configured the necessary build files, you can begin compiling the kernel. The AOSP kernel build process uses the build/build.sh script, and the build is controlled by the BUILD_CONFIG environment variable.\nStep-by-Step Guide to Starting the Build Setting the BUILD_CONFIG Variable: The BUILD_CONFIG variable specifies the path to your configuration file, which contains all the necessary settings for your build, including kernel directories, compiler settings, and other environment variables. You can set the BUILD_CONFIG variable by running the following command in your terminal: export BUILD_CONFIG=common/build.config. Replace with the actual name of your device, or the name you used in your configuration files.\nRunning the Build Script: With the BUILD_CONFIG variable set, you can now trigger the build process by executing the build/build.sh script. The -j option is used to specify the number of jobs to run simultaneously, which can significantly speed up the build process on multi-core systems. For example, to run the build with 14 parallel jobs, you can use: build/build.sh -j14 This command will start the kernel compilation process using the configuration you specified in the BUILD_CONFIG file.\nMonitoring the Build Process: As the build progresses, you’ll see various messages in the terminal, including the compilation of individual source files and linking of the final kernel image. The time it takes to complete the build will depend on your system’s hardware and the complexity of the kernel being built. On a modern multi-core system, the build might take anywhere from several minutes to an hour or more. Successful Compilation: If everything is configured correctly, the build should complete without errors, and the kernel image will be successfully compiled. Customizing build.config.common It’s important to note that the build.config.common file can vary depending on the kernel sources you’re working with. This file contains common settings that are shared across different configurations, such as the default compiler, build options, and any additional environment variables.\nModifying build.config.common: You may need to customize this file to match the specific requirements of your kernel version or device. For instance, the file might include different compiler flags or specify a different defconfig file depending on the target device or kernel features you’re working with. Part 2: Converting to BUILD.bazel Initial Impressions When I first started experimenting with Bazel for kernel builds, my initial reaction was that it seemed overly complex. However, after spending more time with it and testing it across different kernel versions, I came to a conclusion that it is still in development.\nIt’s important to note that Bazel support in kernel builds is still evolving. Currently, only the latest Pixel kernels (starting from Pixel 8 and kernel version 5.15+) fully support Bazel builds. If you’re working with older kernel versions or downstream kernels, you’ll face challenges as Bazel support is either incomplete or entirely missing.\nIf you’re interested in trying Bazel for your custom kernel builds, I strongly recommend starting with kernel version 5.15 or newer. These versions are better supported, and you’ll encounter fewer issues.\nFor those working with older or downstream versions (like the 4.19 kernel mentioned earlier), be prepared for a more challenging experience. You’ll likely need to make significant modifications to get Bazel working correctly. In this section, I’ll share my experience porting a downstream version 4.19 kernel to Bazel, highlighting the challenges I encountered.\nUnderstanding the Basic Bazel File Structure At the heart of the Bazel build system is the BUILD.bazel file. This file is used to define build rules, targets, and dependencies for your project. In the context of a kernel build, the BUILD.bazel file acts as a blueprint, specifying how the kernel and its components should be compiled and linked.\nPrebuilt Bazel Definitons The top-level BUILD.bazel file typically inherits prebuilt Bazel definitions. These definitions are found in the build/bazel/kleaf directory within the AOSP kernel manifest source tree. The kleaf directory contains essential Bazel macros and rules specifically designed for kernel builds.\nYou can load these definitions into your BUILD.bazel file and override them to customize the build process. This allows you to:\nDeclare New Build Targets: Define specific targets for different kernel components or modules. Use External Kernel Modules: Integrate external modules that may not be part of the main kernel source. Customize GKI Configs: Manage Generic Kernel Image (GKI) configurations, which are crucial for Android devices. Create Boot Images: Define how the boot image is generated, including the integration of the compiled kernel and ramdisk. Example of a basic BUILD.bazel file Here’s a simplified example of what a basic BUILD.bazel file might look like:\npackage( default_visibility = [ \"//visibility:public\", ], ) load(\"@bazel_skylib//rules:common_settings.bzl\", \"string_flag\") load(\"//build/bazel_common_rules/dist:dist.bzl\", \"copy_to_dist_dir\") load( \"//build/kernel/kleaf:kernel.bzl\", \"kernel_build\", ) load(\"@kernel_toolchain_info//:dict.bzl\", \"BRANCH\", \"CLANG_VERSION\") kernel_build( name = \"kernel_billie\", srcs = glob( [\"**\"], exclude = [ \"**/BUILD.bazel\", \"**/*.bzl\", \".git/**\", ], ), outs = [ \"Image\", \"System.map\", \"modules.builtin\", \"modules.builtin.modinfo\", \"vmlinux\", \"vmlinux.symvers\", ], build_config = \"build.config.billie\", ) Below is a basic BUILD.bazel file that I created to compile the kernel source discussed earlier, utilizing the kleaf framework provided by Bazel. This file is tailored to work with the specific kernel version and configuration we’ve been discussing. Rather than me explaining each and every bit of line, I’ll prefer going through bazel documentation to checkout, the changes from build.config towards BUILD.bazel here.\nSync Kernel Manifest To ensure you’re working with the latest tools and scripts required for kernel compilation, I recommend syncing the common-android-mainline branch from the kernel/refs+. This branch is kept up-to-date with the latest changes and includes upstreamed scripts that are essential for a smooth build process.\nrepo init -u https://android.googlesource.com/kernel/manifest -b common-android-mainline --depth 1 This branch is particularly advantageous because it includes:\nLatest Compilation Tools: Ensures you have the most recent versions of tools required for kernel builds. Upstreamed Scripts: Contains updated scripts that streamline various stages of the build process, from kernel configuration to image generation. Boot Image Generation: Provides tools necessary for creating boot images directly from the compiled kernel. Kernel ABI and Symbol Generation: Includes utilities for generating ABI symbols, which are critical for ensuring compatibility with the Android ecosystem. Distribution and Artifacts: Facilitates the creation of distribution artifacts, making it easier to package and deploy your kernel. After Sync, the new source tree should look like:\n~/kernel/mainline# tree -L 1 . ├── build ├── common ├── common-modules ├── external ├── kernel ├── MODULE.bazel -\u003e build/kernel/kleaf/bzlmod/bazel.MODULE.bazel ├── prebuilts ├── test └── tools 8 directories, 1 file Once the source tree is set up, the next step is to replace the common directory with your custom kernel source. After doing this, you can proceed to write or modify the BUILD.bazel file to tailor the build process to your specific kernel.To compile the kernel target\nStart the build To initiate the build process for your custom kernel using Bazel:\ntools/bazel build //common:kernel_billie tools/bazel: This specifies the path to the Bazel executable or script that we will use to run the build. build: This Bazel command triggers the build process for the specified target. //common:kernel_billie: This is the Bazel target you are building. In this case, kernel_billie is the target defined in the BUILD.bazel file located in the common directory. This will start the compilation process.\nPorting a Downstream Version 4.19 Kernel to Bazel When I attempted to port a 4.19 downstream kernel to Bazel, I encountered several challenges:\nMissing Bazel Support: The kernel version didn’t natively support Bazel, so I had to manually create BUILD.bazel files for various components. Toolchain Compatibility: Ensuring that the toolchain definitions in the Bazel files matched the kernel’s requirements was tricky, especially when dealing with older versions of Clang or GCC. Dependency Management: Some external kernel modules and dependencies required additional customization to work with Bazel. Successful Compilation If everything is configured correctly, the build should complete without errors, and the kernel image will be successfully compiled. For those interested in diving deeper, I encourage you to explore the official Bazel documentation, which provides extensive resources on setting up and customizing Bazel builds. Ill put everything in references, or you can mail me to ask specific things.\nTips \u0026 Tricks: When setting up your own kernel build definitions and Bazel configurations, it’s beneficial to refer to the Pixel kernel manifest repositories and their associated build.config.pixel files. These resources are maintained by Google and provide a robust base for writing your custom build definitions and Bazel declarations. References: Kernel Manifest android-msm-billie-4.19 linux-sunny android-msm-ginkgo-4.14 Kernel Trees: linux-oneplus-billie kernel_xiaomi_ginkgo AOSP Kernel Build Build with Bazel Let me know your new experiences at my email.\n","wordCount":"2096","inLanguage":"en","datePublished":"2024-08-14T00:00:00+05:30","dateModified":"2024-08-14T00:00:00+05:30","author":{"@type":"Person","name":"squadri"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://danascape.github.io/posts/6/"},"publisher":{"@type":"Organization","name":"Saalim Quadri","logo":{"@type":"ImageObject","url":"https://danascape.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://danascape.github.io/ accesskey=h title="squadri (Alt + H)"><img src=https://danascape.github.io/apple-touch-icon.png alt aria-label=logo height=35>squadri</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://danascape.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://danascape.github.io/posts title=Posts><span>Posts</span></a></li><li><a href=https://danascape.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Using AOSP Kernel Build</h1><div class=post-meta><span title='2024-08-14 00:00:00 +0530 IST'>August 14, 2024</span>&nbsp;·&nbsp;2096 words&nbsp;·&nbsp;squadri&nbsp;|&nbsp;<a href="mailto:saalim.priv@gmail.com?subject=/posts/6/index.md" rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>In my previous blog, we talked about how to cross-compile Android Kernel, but there is another official way that ODMs use to compile their kernel sources, via AOSP Kernel Build.</p><p><img loading=lazy src=/posts/6/img/akb_intro.jpg></p><p>This blog covers 2 aspects:</p><ul><li>Compile using Legacy AOSP Kernel Build</li><li>Add support for bazel Kernel Build</li></ul><p><strong>Bazel</strong> is an open-source build and test tool from Google. It supports a wide range of programming languages and platforms, and it&rsquo;s known for its speed and ability to handle large codebases efficiently. Bazel uses a build system that allows for incremental builds, parallel execution, and sophisticated dependency analysis, making it a popular choice for complex projects like AOSP.</p><p><strong>AOSP Kernel Build System</strong> is the system used to compile the Linux kernel for Android devices. It includes the necessary build scripts, configurations, and toolchains needed to build the kernel from source. The build system is designed to work with AOSP&rsquo;s infrastructure and often uses tools like <code>make</code> and <code>ninja</code> for the actual compilation process.</p><p>In recent years, Bazel has been adopted by some parts of the AOSP for building specific components, but the traditional kernel build process has largely remained based on <code>make</code>. However, there&rsquo;s ongoing work to integrate Bazel more deeply into AOSP&rsquo;s build system to leverage its advantages, like better dependency tracking and faster builds.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><p>Before diving into the AOSP Kernel Build process, certain requirements need to be met:</p><ul><li><strong>Basic File and Text Editing</strong>: Familiarity with editing and writing files and text in a Linux environment.</li><li><strong>Linux Command Line</strong>: Comfort with using the Linux command line interface.</li><li><strong>Basic Git Knowledge</strong>: Understanding basic Git commands and workflows.</li><li><strong>Repo Sync and Manifests</strong>: Familiarity with syncing repositories using <code>repo sync</code> and working with manifest files.</li></ul><h2 id=establishing-a-build-environment>Establishing a Build Environment<a hidden class=anchor aria-hidden=true href=#establishing-a-build-environment>#</a></h2><p>If you&rsquo;ve already set up a Linux build environment, you can skip this step. Otherwise, follow these instructions to get started:</p><ul><li><strong>Setup Script</strong>: Run the following command on your Linux machine with elevated permissions to set up the necessary environment:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl https://raw.githubusercontent.com/akhilnarang/scripts/master/setup/android_build_env.sh | sudo sh
</span></span></code></pre></div><p>This script will install all the required dependencies for building the AOSP Kernel.</p><h2 id=setup-kernel-manifest>Setup Kernel Manifest<a hidden class=anchor aria-hidden=true href=#setup-kernel-manifest>#</a></h2><p>To build the AOSP kernel, you need to set up a kernel manifest, which will allow you to sync the required scripts and compiler.</p><p>To do that, head to <a href=https://android.googlesource.com/kernel/manifest/+refs>here</a> and sync the required manifest. I would recommend using <code>common-</code> and your kernel version branch.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>repo init -u https://android.googlesource.com/kernel/manifest/ -b common-android-4.19-stable --depth <span style=color:#8a7b52>1</span>
</span></span></code></pre></div><ul><li><strong>Depth Sync</strong>: The <code>--depth 1</code> option is used to perform a shallow sync, which is faster because it doesn&rsquo;t download the entire history. This is ideal if you don&rsquo;t need to develop on the build system itself. If you do plan to develop further, you can perform a full sync by omitting the <code>--depth 1</code> option.</li></ul><p>After a sync, you can view the structure of the source tree:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>~/kernel/sp# tree -L <span style=color:#8a7b52>1</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── build
</span></span><span style=display:flex><span>├── common
</span></span><span style=display:flex><span>├── common-modules
</span></span><span style=display:flex><span>├── hikey-modules
</span></span><span style=display:flex><span>├── kernel
</span></span><span style=display:flex><span>├── prebuilts
</span></span><span style=display:flex><span>├── prebuilts-master
</span></span><span style=display:flex><span>└── tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8a7b52>8</span> directories, <span style=color:#8a7b52>0</span> files
</span></span></code></pre></div><p>Inside the <code>common/</code> directory, you&rsquo;ll find the Android Common Kernel source, which we won&rsquo;t need for our purposes. You can replace this with your own kernel source.</p><p>Replace common kernel directory with your kernel source with version V4.19.</p><h2 id=setup-build-config>Setup Build Config<a hidden class=anchor aria-hidden=true href=#setup-build-config>#</a></h2><p>The AOSP Kernel Build system relies on a <code>BUILD_CONFIG</code> variable, which configures the build environment, including kernel configuration and compiler flags.</p><ul><li>Create a file named <code>build.config.&lt;device-name></code><ul><li>Write basic configuration, like your kernel build directory, which is set to common by default, then required defconfig</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#434f54>KERNEL_DIR</span><span style=color:#728e00>=</span>common
</span></span><span style=display:flex><span><span style=color:#a61717>.</span> <span style=color:#a61717>${ROOT_DIR}/${KERNEL_DIR}/build.config.billie.common.clang</span>
</span></span></code></pre></div><ul><li>Create a file named <code>build.config.&lt;device-name>.common.clang</code><ul><li>Specify compiler settings, I am differing the names with my perspective, these can be anything.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#a61717>.</span> <span style=color:#a61717>${ROOT_DIR}/${KERNEL_DIR}/build.config.billie.common</span>
</span></span><span style=display:flex><span><span style=color:#434f54>CC</span><span style=color:#728e00>=</span>clang
</span></span><span style=display:flex><span><span style=color:#434f54>LD</span><span style=color:#728e00>=</span>ld.lld
</span></span><span style=display:flex><span><span style=color:#434f54>CLANG_TRIPLE</span><span style=color:#728e00>=</span>aarch64-linux-gnu-
</span></span></code></pre></div><ul><li>Create a file named <code>build.config.billie.common</code><ul><li>To call the common configuration and define additional settings.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#a61717>.</span> <span style=color:#a61717>${ROOT_DIR}/${KERNEL_DIR}/build.config.common</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>BUILD_INITRAMFS</span><span style=color:#728e00>=</span><span style=color:#8a7b52>1</span>
</span></span><span style=display:flex><span><span style=color:#434f54>DEFCONFIG</span><span style=color:#728e00>=</span>vendor/billie-perf_defconfig
</span></span></code></pre></div><p>Here, the <code>build.config.common</code> file, which is already present in the kernel directory, contains the remaining configuration.</p><p>You can find the full reference commit <a href=https://github.com/stormbreaker-project/linux-oneplus-billie/commit/bc0d710d79324ca2654ae5e0d9b7ce35cf7e41e4>here</a>. Fill in the remaining configuration details as per your needs. Depending on your kernel version, you can fully utilize the Build System to start the kernel build process and package the distribution into a boot image.</p><h2 id=starting-the-build>Starting the build<a hidden class=anchor aria-hidden=true href=#starting-the-build>#</a></h2><p>Once you have set up your build environment and configured the necessary build files, you can begin compiling the kernel. The AOSP kernel build process uses the <code>build/build.sh</code> script, and the build is controlled by the <code>BUILD_CONFIG</code> environment variable.</p><h3 id=step-by-step-guide-to-starting-the-build>Step-by-Step Guide to Starting the Build<a hidden class=anchor aria-hidden=true href=#step-by-step-guide-to-starting-the-build>#</a></h3><ol><li><strong>Setting the <code>BUILD_CONFIG</code> Variable:</strong><ul><li>The <code>BUILD_CONFIG</code> variable specifies the path to your configuration file, which contains all the necessary settings for your build, including kernel directories, compiler settings, and other environment variables.</li><li>You can set the <code>BUILD_CONFIG</code> variable by running the following command in your terminal:</li></ul></li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#728e00>export </span><span style=color:#434f54>BUILD_CONFIG</span><span style=color:#728e00>=</span>common/build.config.&lt;device-name&gt;
</span></span></code></pre></div><p>Replace <code>&lt;device-name></code> with the actual name of your device, or the name you used in your configuration files.</p><ul><li>Running the Build Script:<ul><li>With the <code>BUILD_CONFIG</code> variable set, you can now trigger the build process by executing the <code>build/build.sh</code> script.</li><li>The <code>-j</code> option is used to specify the number of jobs to run simultaneously, which can significantly speed up the build process on multi-core systems. For example, to run the build with 14 parallel jobs, you can use:</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>build/build.sh -j14
</span></span></code></pre></div><p><img loading=lazy src=/posts/6/img/akb_start.png></p><p>This command will start the kernel compilation process using the configuration you specified in the <code>BUILD_CONFIG</code> file.</p><ul><li>Monitoring the Build Process:<ul><li>As the build progresses, you&rsquo;ll see various messages in the terminal, including the compilation of individual source files and linking of the final kernel image.</li><li>The time it takes to complete the build will depend on your system&rsquo;s hardware and the complexity of the kernel being built. On a modern multi-core system, the build might take anywhere from several minutes to an hour or more.</li></ul></li><li>Successful Compilation:<ul><li>If everything is configured correctly, the build should complete without errors, and the kernel image will be successfully compiled.</li></ul></li></ul><p><img loading=lazy src=/posts/6/img/akb_complete.png></p><h3 id=customizing-buildconfigcommon>Customizing <code>build.config.common</code><a hidden class=anchor aria-hidden=true href=#customizing-buildconfigcommon>#</a></h3><p>It&rsquo;s important to note that the <code>build.config.common</code> file can vary depending on the kernel sources you&rsquo;re working with. This file contains common settings that are shared across different configurations, such as the default compiler, build options, and any additional environment variables.</p><ul><li>Modifying <code>build.config.common</code>:<ul><li>You may need to customize this file to match the specific requirements of your kernel version or device.</li><li>For instance, the file might include different compiler flags or specify a different defconfig file depending on the target device or kernel features you&rsquo;re working with.</li></ul></li></ul><h2 id=part-2-converting-to-buildbazel>Part 2: Converting to BUILD.bazel<a hidden class=anchor aria-hidden=true href=#part-2-converting-to-buildbazel>#</a></h2><h3 id=initial-impressions>Initial Impressions<a hidden class=anchor aria-hidden=true href=#initial-impressions>#</a></h3><p>When I first started experimenting with Bazel for kernel builds, my initial reaction was that it seemed overly complex. However, after spending more time with it and testing it across different kernel versions, I came to a conclusion that it is still in development.</p><p>It&rsquo;s important to note that Bazel support in kernel builds is still evolving. Currently, only the latest Pixel kernels (starting from Pixel 8 and kernel version 5.15+) fully support Bazel builds. If you&rsquo;re working with older kernel versions or downstream kernels, you&rsquo;ll face challenges as Bazel support is either incomplete or entirely missing.</p><p>If you&rsquo;re interested in trying Bazel for your custom kernel builds, I strongly recommend starting with kernel version 5.15 or newer. These versions are better supported, and you&rsquo;ll encounter fewer issues.</p><p>For those working with older or downstream versions (like the 4.19 kernel mentioned earlier), be prepared for a more challenging experience. You&rsquo;ll likely need to make significant modifications to get Bazel working correctly. In this section, I&rsquo;ll share my experience porting a downstream version 4.19 kernel to Bazel, highlighting the challenges I encountered.</p><h3 id=understanding-the-basic-bazel-file-structure>Understanding the Basic Bazel File Structure<a hidden class=anchor aria-hidden=true href=#understanding-the-basic-bazel-file-structure>#</a></h3><p>At the heart of the Bazel build system is the <code>BUILD.bazel</code> file. This file is used to define build rules, targets, and dependencies for your project. In the context of a kernel build, the <code>BUILD.bazel</code> file acts as a blueprint, specifying how the kernel and its components should be compiled and linked.</p><h3 id=prebuilt-bazel-definitons>Prebuilt Bazel Definitons<a hidden class=anchor aria-hidden=true href=#prebuilt-bazel-definitons>#</a></h3><p>The top-level <code>BUILD.bazel</code> file typically inherits prebuilt Bazel definitions. These definitions are found in the <code>build/bazel/kleaf</code> directory within the AOSP kernel manifest source tree. The <code>kleaf</code> directory contains essential Bazel macros and rules specifically designed for kernel builds.</p><p>You can load these definitions into your <code>BUILD.bazel</code> file and override them to customize the build process. This allows you to:</p><ul><li><strong>Declare New Build Targets</strong>: Define specific targets for different kernel components or modules.</li><li><strong>Use External Kernel Modules</strong>: Integrate external modules that may not be part of the main kernel source.</li><li><strong>Customize GKI Configs</strong>: Manage Generic Kernel Image (GKI) configurations, which are crucial for Android devices.</li><li><strong>Create Boot Images</strong>: Define how the boot image is generated, including the integration of the compiled kernel and ramdisk.</li></ul><h3 id=example-of-a-basic-buildbazel-file>Example of a basic <code>BUILD.bazel</code> file<a hidden class=anchor aria-hidden=true href=#example-of-a-basic-buildbazel-file>#</a></h3><p>Here&rsquo;s a simplified example of what a basic <code>BUILD.bazel</code> file might look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#434f54>package</span>(
</span></span><span style=display:flex><span>    <span style=color:#434f54>default_visibility</span> <span style=color:#728e00>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;//visibility:public&#34;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>load</span>(<span style=color:#7f8c8d>&#34;@bazel_skylib//rules:common_settings.bzl&#34;</span>, <span style=color:#7f8c8d>&#34;string_flag&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#434f54>load</span>(<span style=color:#7f8c8d>&#34;//build/bazel_common_rules/dist:dist.bzl&#34;</span>, <span style=color:#7f8c8d>&#34;copy_to_dist_dir&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>load</span>(
</span></span><span style=display:flex><span>    <span style=color:#7f8c8d>&#34;//build/kernel/kleaf:kernel.bzl&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#7f8c8d>&#34;kernel_build&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#434f54>load</span>(<span style=color:#7f8c8d>&#34;@kernel_toolchain_info//:dict.bzl&#34;</span>, <span style=color:#7f8c8d>&#34;BRANCH&#34;</span>, <span style=color:#7f8c8d>&#34;CLANG_VERSION&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#434f54>kernel_build</span>(
</span></span><span style=display:flex><span>   <span style=color:#434f54>name</span> <span style=color:#728e00>=</span> <span style=color:#7f8c8d>&#34;kernel_billie&#34;</span>,
</span></span><span style=display:flex><span>   <span style=color:#434f54>srcs</span> <span style=color:#728e00>=</span> <span style=color:#434f54>glob</span>(
</span></span><span style=display:flex><span>       [<span style=color:#7f8c8d>&#34;**&#34;</span>],
</span></span><span style=display:flex><span>       <span style=color:#434f54>exclude</span> <span style=color:#728e00>=</span> [
</span></span><span style=display:flex><span>           <span style=color:#7f8c8d>&#34;**/BUILD.bazel&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#7f8c8d>&#34;**/*.bzl&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#7f8c8d>&#34;.git/**&#34;</span>,
</span></span><span style=display:flex><span>       ],
</span></span><span style=display:flex><span>   ),
</span></span><span style=display:flex><span>    <span style=color:#434f54>outs</span> <span style=color:#728e00>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;Image&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;System.map&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;modules.builtin&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;modules.builtin.modinfo&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;vmlinux&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7f8c8d>&#34;vmlinux.symvers&#34;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>   <span style=color:#434f54>build_config</span> <span style=color:#728e00>=</span> <span style=color:#7f8c8d>&#34;build.config.billie&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Below is a basic <code>BUILD.bazel</code> file that I created to compile the kernel source discussed earlier, utilizing the <code>kleaf</code> framework provided by Bazel. This file is tailored to work with the specific kernel version and configuration we&rsquo;ve been discussing.
Rather than me explaining each and every bit of line, I&rsquo;ll prefer going through bazel documentation to checkout, the changes from <code>build.config</code> towards <code>BUILD.bazel</code> <a href=https://android.googlesource.com/kernel/build/+/refs/heads/main/kleaf/docs/build_configs.md>here</a>.</p><h3 id=sync-kernel-manifest>Sync Kernel Manifest<a hidden class=anchor aria-hidden=true href=#sync-kernel-manifest>#</a></h3><p>To ensure you&rsquo;re working with the latest tools and scripts required for kernel compilation, I recommend syncing the <code>common-android-mainline</code> branch from the <code>kernel/refs+</code>. This branch is kept up-to-date with the latest changes and includes upstreamed scripts that are essential for a smooth build process.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>repo init -u https://android.googlesource.com/kernel/manifest -b common-android-mainline --depth <span style=color:#8a7b52>1</span>
</span></span></code></pre></div><p>This branch is particularly advantageous because it includes:</p><ul><li><strong>Latest Compilation Tools</strong>: Ensures you have the most recent versions of tools required for kernel builds.</li><li><strong>Upstreamed Scripts</strong>: Contains updated scripts that streamline various stages of the build process, from kernel configuration to image generation.</li><li><strong>Boot Image Generation</strong>: Provides tools necessary for creating boot images directly from the compiled kernel.</li><li><strong>Kernel ABI and Symbol Generation</strong>: Includes utilities for generating ABI symbols, which are critical for ensuring compatibility with the Android ecosystem.</li><li><strong>Distribution and Artifacts</strong>: Facilitates the creation of distribution artifacts, making it easier to package and deploy your kernel.</li></ul><p>After Sync, the new source tree should look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>~/kernel/mainline# tree -L 1
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── build
</span></span><span style=display:flex><span>├── common
</span></span><span style=display:flex><span>├── common-modules
</span></span><span style=display:flex><span>├── external
</span></span><span style=display:flex><span>├── kernel
</span></span><span style=display:flex><span>├── MODULE.bazel -&gt; build/kernel/kleaf/bzlmod/bazel.MODULE.bazel
</span></span><span style=display:flex><span>├── prebuilts
</span></span><span style=display:flex><span>├── test
</span></span><span style=display:flex><span>└── tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>8 directories, 1 file
</span></span></code></pre></div><p>Once the source tree is set up, the next step is to replace the <code>common</code> directory with your custom kernel source.
After doing this, you can proceed to write or modify the <code>BUILD.bazel</code> file to tailor the build process to your specific kernel.To compile the kernel target</p><h3 id=start-the-build>Start the build<a hidden class=anchor aria-hidden=true href=#start-the-build>#</a></h3><p>To initiate the build process for your custom kernel using Bazel:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>tools/bazel build //common:kernel_billie
</span></span></code></pre></div><ul><li><code>tools/bazel</code>: This specifies the path to the Bazel executable or script that we will use to run the build.</li><li><code>build</code>: This Bazel command triggers the build process for the specified target.</li><li><code>//common:kernel_billie</code>: This is the Bazel target you are building.
In this case, <code>kernel_billie</code> is the target defined in the <code>BUILD.bazel</code> file located in the <code>common</code> directory.</li></ul><p>This will start the compilation process.</p><p><img loading=lazy src=/posts/6/img/bazel-start.png></p><h3 id=porting-a-downstream-version-419-kernel-to-bazel>Porting a Downstream Version 4.19 Kernel to Bazel<a hidden class=anchor aria-hidden=true href=#porting-a-downstream-version-419-kernel-to-bazel>#</a></h3><p>When I attempted to port a 4.19 downstream kernel to Bazel, I encountered several challenges:</p><ul><li><strong>Missing Bazel Support</strong>: The kernel version didn&rsquo;t natively support Bazel, so I had to manually create <code>BUILD.bazel</code> files for various components.</li><li><strong>Toolchain Compatibility</strong>: Ensuring that the toolchain definitions in the Bazel files matched the kernel&rsquo;s requirements was tricky, especially when dealing with older versions of Clang or GCC.</li><li><strong>Dependency Management</strong>: Some external kernel modules and dependencies required additional customization to work with Bazel.</li></ul><h4 id=successful-compilation>Successful Compilation<a hidden class=anchor aria-hidden=true href=#successful-compilation>#</a></h4><ul><li>If everything is configured correctly, the build should complete without errors, and the kernel image will be successfully compiled.</li></ul><p><img loading=lazy src=/posts/6/img/bazel-end.png></p><p>For those interested in diving deeper, I encourage you to explore the official Bazel documentation, which provides extensive resources on setting up and customizing Bazel builds. Ill put everything in references, or you can mail me to ask specific things.</p><h3 id=tips--tricks>Tips & Tricks:<a hidden class=anchor aria-hidden=true href=#tips--tricks>#</a></h3><ul><li>When setting up your own kernel build definitions and Bazel configurations, it&rsquo;s beneficial to refer to the Pixel kernel manifest repositories and their associated <code>build.config.pixel</code> files. These resources are maintained by Google and provide a robust base for writing your custom build definitions and Bazel declarations.</li></ul><h3 id=references>References:<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li>Kernel Manifest<ul><li><a href=https://github.com/stormbreaker-project/platform_kernel_manifest/tree/android-msm-billie-4.19>android-msm-billie-4.19</a></li><li><a href=https://github.com/aosp-sunny/android_kernel_manifest>linux-sunny</a></li><li><a href=https://github.com/stormbreaker-project/platform_kernel_manifest/tree/android-msm-ginkgo-4.14>android-msm-ginkgo-4.14</a></li></ul></li><li>Kernel Trees:<ul><li><a href=https://github.com/stormbreaker-project/linux-oneplus-billie/commits/master/>linux-oneplus-billie</a></li><li><a href=https://github.com/stormbreaker-project/kernel_xiaomi_ginkgo/commit/cb1b17ba081806b7568b856903ee1bc385eff726>kernel_xiaomi_ginkgo</a></li></ul></li><li><a href=https://source.android.com/docs/setup/build/building-kernels>AOSP Kernel Build</a></li><li><a href=https://android.googlesource.com/kernel/build/+/refs/heads/main/kleaf/docs/impl.md>Build with Bazel</a></li></ul><p>Let me know your new experiences at <a href=mail:saalim.priv@gmail.com>my email</a>.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://danascape.github.io/posts/7/><span class=title>« Prev</span><br><span>Google Summer of Code: Midterm Evaluation</span>
</a><a class=next href=https://danascape.github.io/posts/5/><span class=title>Next »</span><br><span>Cross-Compiling Android Linux Kernel</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://danascape.github.io/>Saalim Quadri</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>